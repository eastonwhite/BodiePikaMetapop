---
number_sections: yes
bibliography: White_bib.bib
output: 
  pdf_document: 
    fig_caption: true
---
\vspace{2cm}

\begin{center}
 \textbf{Supplementary Material: The inevitable partial collapse of an American pika metapopulation}
 
 Easton R. White, John D. Nagy, Andrew T. Smith 

August 12, 2015
 \end{center}

\vspace{2cm}

This supplementary material includes:

1. Mathematical description of our model
2. Inverse pattern-orientated estimation procedure
3. Effects of spatial structure and patch heterogeneity
4. Parameter sensitivity
5. Effect of unsampled patches
6. Long term dynamics
7. Individual patch dynamics over time

\vspace{2cm}

### 1 Expanded methods
#### Model description
Let $\mathbf{x}(n)$ be the total number of pikas at Bodie at census time $n$, where $n \in \{0,1,2,\ldots\}$. We denote the total number of pikas on a given patch, $j$, as $x_j(n),\, j \in \{1,2,3,\ldots,79\}$. Note that all pikas in a given census are considered breeding adults because juvenile pikas that survive their first year are then capable of reproduction. To match the timing of the actual Bodie census, we assume our model census takes place in late summer/early fall, just before the winter season at Bodie. For simplicity, we assume males and females are equivalent, except for the fact that only females can reproduce. We also assume that adults do not disperse and that juveniles only get one opportunity to disperse (immediately after they are born). We model fecundity using available litter size data and mortality as a binomial random variables. We assume dispersal is a piece-wise function of distance between patches governed by a multinomial random variable. All of these assumptions are rooted in the available literature on pika biology (citations). 

#### Fecundity
We assume an equal sex ratio and that all females are able to reproduce in a given year. Let $R_f$ be a Poisson-distributed random variable describing the number of females born to a reproducing female, $f$, in a given year. We assume that all breeding females, regardless of age or location, have the same reproduction output. Because pikas are able to reproduce after their first year, we let $B_j(n)$ represent the total reproductive output of the entire patch in year $n$.
\begin{equation}
 B_j(n) = \sum_{f=1}^{\mathbf{x}(n-1)} R_f
\end{equation}

After reproduction occurs, there is some loss of juvenile pikas during weaning. [@Millar1973] estimated that 21% of juvenile pikas may die at this period. His work took place at a high altitude site in Alberta. We do not have a similar estimate for pikas at Bodie. Therefore we estimated the probability of weaning mortality using an inverse modeling approach (see below). The number of pikas that die due to weaning mortality is calculated using a binomial random variable with probability set at the value we estimated using the inverse modeling approach. 

#### Dispersal
After juveniles pikas are born, a subset of them are allowed to disperse to a new patch. Individuals who do not disperse, compete for territories (can only obtain a territory if one is unoccupied) on their natal patch. If these individuals cannot obtain an empty territory by winter, they will die. The number of pikas allowed to disperse is governed by a binomial random variable with rate=0.25 [@Smith1987]. Dispersal among patches appears to be density-dependent. The simplest assumption to make is that pikas can only disperse to nearby patches (within 300 meters). Let $D_j(n)$ denote the number of dispersing pikas from a particular patch $j$ in year $n$. We denote $c$ to be the mean dispersal propensity for an individual pika. We assume $D_j(n)$ to be a binomial random variable that has the probability distribution
\begin{equation}
  \Pr(\{D_j(n) = d \}) = {B_j(n) \choose d} c^d (1-c)^{B_j(n) - d}, \hspace{2ex} d \in \{0,1,\ldots,R_f\}.
\end{equation}
Each of the dispersing pikas, from $D_j(n)$, then disperses away from their natal patch to a target patch. The probability an individual pika targets a particular patch $i$ from their natal patch $j$ is the same for all patches within 300 meters of the natal patch $j$, and zero for all other patches.

We let $U_i$, where $i \in \{1,2,\ldots,78\}$ be a multinomial-distributed random variable for dispersing a pika from natal patch $j$ to one of 78 possibilities.  
\begin{equation}
Pr(\{U_1 = u_1, U_2 = u_2, \ldots, U_{78}= u_{78}\}) = \frac{78!}{u_1!\ldots u_{78}!} p_{j1}^{u_1}\ldots p_{j78}^{u_{78}}
\end{equation}


Once a dispersing pika is assigned a target patch, the disperser also endures a probability of mortality while dispersing. We denote $Y_i$ to be the number the number of pikas who chose a particular patch $i$. We assume $Y_i$ to be a binomial random variable that has the following probability distribution according to the probability rate $d_m$=0.55. This value was chosen by an inverse pattern-orientated approach (see next section).
\begin{equation}
  \Pr(\{Y_i = y \}) = {U_i \choose y} d_m^y (1-d_m)^{U_i - y}, \hspace{2ex} y \in \{0,1,\ldots, U_i\}.
\end{equation}

#### Competition for territories 
Pikas that survive dispersal then compete for territories on their new patches. We assume that if no territories are vacant on their given patch, they are not able to acquire a territory and subsequently die during winter. In the case where there are vacant territories, these pikas fill all open territories. Any pikas without a territory after this time also die during winter. This same process for acquiring territories is also used for pikas that do not disperse and stay on their natal patch. 

#### Adult mortality
Adult pikas endure some probability of mortality throughout the entire year. We denote the constant probability of mortality as $\mu$ and define $M_a(n)$ to be a random variable representing number of deaths at a particular patch $j \in \{1,2,\ldots,79\}$. Then
\begin{equation} \label{mort_pdf}
  \Pr(\{M_j(n) = m \}) = {x_j(n) \choose m} \mu^m (1-\mu)^{x_j - m}, \hspace{2ex} m \in \{0,1,\ldots,x_j(n)\}.
\end{equation}

We assume that all pikas that acquire a territory have enough time to build a hay pile and survive until winter. However all individuals endure an over-winter probability of mortality. We also assume that over-winter mortality rate is invariant across the study site. Our assumption of mortality rate invariant in space can be relaxed but it serves as a good first approximation.




```{r,echo=FALSE}
setwd('/Users/easton2/Desktop/Research/Nagy Lab/Pikas/Modeling/SimpleBodieModel')
#bibliography: White_bib.bibtex
#Need to run models here, or pull in model outputs
sampled_census_bodie <- read.table("sampled_census_bodie.txt",header=T,sep= " ")
names(sampled_census_bodie) <- c(1972,1977,1989,1991,1992,1993,1994,1995,1996,      1997,1998,1999,2000,2001,2003,2004,2005, 2006,2008,2009)
```

```{r,eval=TRUE,message=FALSE,echo=FALSE,fig.width=4,fig.height=4,fig.cap="Mean squared error versus dispersal mortality probability and weaning mortality probability for default parameter values (see main text). The color indicates the mean squared error."}
# load("inverse_modeling_1000trials.Rdata")
# par(mfrow=c(1,1), mai = c(1.5, 1, 0.5,0.5),oma=c(0.5,1.5,0,0))
# plot(d_m_vector,trial_trial_error, pch=16,col='black',ylab='Mean squared error',
#      xlab='Dispersal mortality probability',ylim=c(20000,45000))
# prediction=loess(as.numeric(trial_trial_error)~as.numeric(d_m_vector))
# lines(seq(0.01,0.99,0.001),predict(prediction,data.frame(d_m_vector=seq(0.01,0.99,0.001))),col='red',lwd=2)
#which(round(predict(prediction,data.frame(d_m_vector=seq(0.01,0.99,0.001))))==21106)
load("~/Desktop/Research/Nagy Lab/Pikas/Modeling/SimpleBodieModel/Model-Outputs/inverse_modeling_100trials_2401combo_d_and_w.Rdata")
require(lattice)
levelplot(trial_trial_error~d_m_vector*weaning_m_vector,col.regions = terrain.colors(1000),ylab="weaning mortality probability",xlab="dispersal mortality probability",
panel = function(...){ 
  panel.levelplot(...) 
  panel.abline(h = .52,lwd = 2,type = 2) 
  panel.abline(v = .48,lwd = 2,type = 2) }
          )
#abline(h=0.52,lty=2,lwd=2)
```

### 2. Estimation of weaning mortality and disperser mortality probablities

When pikas are born they face high mortality rates. A lot of mortality occurs between birth and the time juvenile pikas are weaned. Millar 1973 estimated that 21% of juvenile pikas may die at this period. His work took place at high altitude (classic pika habitat) site in Alberta. We do not have a similar estimate for pikas at Bodie. 

Although the importance of the cost of dispersal in driving dynamics at Bodie has been noted by several authors [cite], we still do not have a good field estimate of the parameter. Past work has indicated that the cost of dispersal must be high [citations]. During dispersal, juvenile pikas are often chased off patches by established adults, killed by predators, and have to endure high summer temperatures [citations]. 

We used our simulation model and an inverse pattern-orientated approach to estimate disperser mortality probability and the probability of mortality during weaning [@Hartig2011; @White2014]. Essentially, we ran our simulation model with different combinations of dispersal mortality probabilities and weaning mortality probabilities. We then compared model outputs to census data. Here is a more detailed explanation of our approach:

1. We initialized our model with census data from the year 1991 and the other parameter values we have estimated in the field. We initialized the model with 1991 census data because the period between 1991 and 2009 is the most continuous set of census data we have for Bodie. 
2. We then ran the model 1000 times for each different values of disperser mortality probability and weaning mortality probability from 0.01 to 0.99 for a total of 2401 parameter combinations. 
3. For parameter combination, we calculated the mean squared difference between the total census size and the total census size predicted by our model for the subset of census years from 1991 to 2009.
4. Our estimated disperser mortality probability and weaning mortality probability are the values that minimized this mean squared difference (see fig). 
5. We then used these probability estimates in the model with initial conditions from the year 1972 in the rest of the paper (see manuscript).

We found that a disperser mortality probability of 0.48 and a weaning mortality probability of 0.52 minimized the mean squared error between our predicted total population size and the census data. The high weaning mortality probability may be a reflection of two possibilities. First, the weaning mortality probability may actually be that high due to the ecological mechanisms outlined earlier. Second, the reproductive output of pikas estimated by [@Smith1978], and used in our model, may be an overestimate. It is unclear if he would have sampled any pikas that were not pregnant. Further work in the field is needed to verify the values we found for disperser mortality probability and weaning mortality probability.

### 3. Parsing out the effects of spatial structure and patch heterogeneity

As pointed out by several papers, spatial structure and patch size are both important components of a metapopulation [citations]. In our paper, spatial structure is the actual layout of patches on the Bodie landscape. For us, patch size is the number of territories on each patch. For most of our simulations, we examine models with the actual Bodie spatial structure and the heterogeneity in number of territories per patch. However, it is also interesting to examine model outcomes when we relax these assumptions. Therefore, with a 2x2 full factorial design we examined the importance of these two assumptions: (1) no spatial structure (global dispersal, all patches are equally connected) and homogeneous patches (same number of territories per patch), (2) Bodie's spatial structure and homogeneous patches, (3) no spatial structure and heterogeneous patches, and lastly (4) the actual Bodie spatial structure and heterogeneity in patches. We then made the same six measurements of the different models as we did in the rest of the paper. 



```{r,echo=FALSE}
####TABLE OF EXPERIMENT MODEL RESULTS####

load("~/Desktop/Research/Nagy Lab/Pikas/Modeling/SimpleBodieModel/Model-Outputs/FourModelExperiment_1000trials1000years.Rdata")

ModelNames = c("Field Data","Bodie spatial structure, patch heterogeneity","Bodie spatial structure, patch homogeneity", "No spatial structure, patch heterogeneity","No spatial structure, patch homogeneity")
TableHeaders= c('Mean pop. size','Variance','Patch occupancy', 'Collapse year', '# extinct. events','# recolon. events','Error')
experiment=matrix(0,nrow=5,ncol=7)
rownames(experiment)=ModelNames
colnames(experiment)=TableHeaders

  ext_events = matrix(0,nrow=1,ncol=19)
  recol_events = matrix(0,nrow=1,ncol=19)
  for (j in 1:19){
    ext_events[,j] = sum(sampled_census_bodie[,j]>0 & sampled_census_bodie[,j+1]==0,na.rm=T)
    recol_events[,j] = sum(sampled_census_bodie[,j]==0 & sampled_census_bodie[,j+1]>0,na.rm=T)
  }
census_ext_events=sum(ext_events)
census_recol_events=sum(recol_events)

experiment[1,1:7]=c(mean(colSums(sampled_census_bodie,na.rm=T)),var(colSums(sampled_census_bodie,na.rm=T)),mean(colSums(sampled_census_bodie>0,na.rm=T)/66),as.numeric(names(which((colSums(sampled_census_bodie[c(2:19,21:37,57,58),]))<14)[1])),census_ext_events,census_recol_events,0)
experiment[2:5,1]=c(mean(trial_mean),mean(two_trial_mean),mean(three_trial_mean),mean(four_trial_mean))
experiment[2:5,2]=c(mean(trial_variance),mean(two_trial_variance),mean(three_trial_variance),mean(four_trial_variance))
experiment[2:5,3]=c(mean(trial_occupancy),mean(two_trial_occupancy),mean(three_trial_occupancy),mean(four_trial_occupancy))
experiment[2:5,4]=c(mean(trial_ext_year),mean(two_trial_ext_year),mean(three_trial_ext_year),mean(four_trial_ext_year))
experiment[2:5,5]=c(mean(trial_ext_events),mean(two_trial_ext_events),mean(three_trial_ext_events),mean(four_trial_ext_events))
experiment[2:5,6]=c(mean(trial_recol_events),mean(two_trial_recol_events),mean(three_trial_recol_events),mean(four_trial_recol_events))
experiment[2:5,7]=c(mean(trial_error),mean(two_trial_error),mean(three_trial_error),mean(four_trial_error))

library(knitr)
kable(experiment[,1:4], digits=2,caption = 'Four model experiment...')
kable(experiment[,5:7], digits=2)
```



```{r,echo=F, tidy=T,fig.cap='Comparison of four different simulation designs representing combinations of different spatial patterns and patch heterogeneities. The dashed horizontal line on each patch represents the actual measured value from the field. 1000 trials were run for each treatment.'}
load("~/Desktop/Research/Nagy Lab/Pikas/Modeling/SimpleBodieModel/Model-Outputs/FourModelExperiment_1000trials1000years.Rdata")
par(mfrow=c(2,2),mar=c(3,3.5,1,1),oma=c(2,2,0,0))
boxplot(c(trial_mean),c(two_trial_mean),c(three_trial_mean),c(four_trial_mean),xlab=' ',las=1,ylab=' ',outline=T,medlwd=0.7,outpch=20,boxlty=0,outcol=rgb(0.3,0.3,0.3,0.5),notch=F,at=1:4,col=c(rgb(0.3,0.3,0.3,1),rgb(0.7,0.7,0.7,1)),border='black',ylim=c(0,200))

text(cex=1,c(1.5,3.5), y=par()$usr[3]-0.05*(par()$usr[4]-par()$usr[3]), xpd=TRUE, srt=0,adj=1, pos=1,labels=c(paste("Bodie spatial \nstructure"),paste("No spatial \nstructure")))

mtext('Mean population size',side=2,line=3,outer=F)
#mtext('Model setup',side=1,line=0.5,outer=T,at =0.55)
abline(h=87,lty=2,lwd=2)


boxplot(c(trial_variance),c(two_trial_variance),c(three_trial_variance),c(four_trial_variance),xlab=' ',las=1,ylab=' ', outline=T, medlwd=0.7,outpch=20,boxlty=0, outcol=rgb(0.3,0.3,0.3,0.5),notch=F,at=1:4,col=c(rgb(0.3,0.3,0.3,1),rgb(0.7,0.7,0.7,1)),border='black',ylim=c(0,3000))

text(cex=1,c(1.5,3.5), y=par()$usr[3]-0.05*(par()$usr[4]-par()$usr[3]), xpd=TRUE, srt=0,adj=1, pos=1,labels=c(paste("Bodie spatial \nstructure"),paste("No spatial \nstructure")))

#legend('topleft',legend=c('Patch heterogeneity','Patch Homogeneity'), col=c(rgb(0.3,0.3,0.3,1),rgb(0.7,0.7,0.7,1)),pch=15)

mtext('Variance in pop. size',side=2,line=3,outer=F)
#mtext('Model setup',side=1,line=0.5,outer=T,at =0.55)
abline(h=860,lty=2,lwd=2)



boxplot(c(trial_occupancy),c(two_trial_occupancy),c(three_trial_occupancy),c(four_trial_occupancy),xlab=' ',las=1,ylab=' ',outline=T, medlwd=0.7,outpch=20, boxlty=0,outcol=rgb(0.3,0.3,0.3,0.5), notch=F,at=1:4,col=c(rgb(0.3,0.3,0.3,1), rgb(0.7,0.7,0.7,1)),border='black',ylim=c(0,1))

text(cex=1,c(1.5,3.5), y=par()$usr[3]-0.05*(par()$usr[4]-par()$usr[3]), xpd=TRUE, srt=0,adj=1, pos=1,labels=c(paste("Bodie spatial \nstructure"),paste("No spatial \nstructure")))

legend('topleft',legend=c('Patch heterogeneity','Patch homogeneity'), col=c(rgb(0.3,0.3,0.3,1),rgb(0.7,0.7,0.7,1)),pch=15)

#legend('topleft',legend=c('Patch heterogeneity','Patch Homogeneity'),col=c(rgb(0.3,0.3,0.3,1),
 #                                                                          rgb(0.7,0.7,0.7,1)),pch=15)

mtext('Patch occupancy',side=2,line=3,outer=F)
#mtext('Model setup',side=1,line=0.5,outer=T,at =0.55)
abline(h=0.38,lty=2,lwd=2)



boxplot(c(trial_ext_year),c(two_trial_ext_year),c(three_trial_ext_year),c(four_trial_ext_year),
        xlab=' ',las=1,ylab=' ',outline=T,medlwd=0.7,outpch=20,boxlty=0,outcol=rgb(0.3,0.3,0.3,0.5),notch=F,at=1:4,col=c(rgb(0.3,0.3,0.3,1),rgb(0.7,0.7,0.7,1)),border='black',ylim=c(1970,2170))

text(cex=1,c(1.5,3.5), y=par()$usr[3]-0.05*(par()$usr[4]-par()$usr[3]), xpd=TRUE, srt=0,adj=1, pos=1,labels=c(paste("Bodie spatial \nstructure"),paste("No spatial \nstructure")))



#legend('topleft',legend=c('Patch heterogeneity','Patch Homogeneity'),col=c(rgb(0.3,0.3,0.3,1),
 #                                                                          rgb(0.7,0.7,0.7,1)),pch=15)

mtext('Year of southern collapse',side=2,line=3,outer=F)
mtext('Model setup',side=1,line=0.5,outer=T,at =0.55)
abline(h=1990,lty=2,lwd=2)

```


### 4. Parameter sensitivity

Although we have good estimates for dispersal propensity, birth rates, maximum dispersal distance, and over-winter mortality probability, it is still insightful to test the sensitivity of these different parameters. We also tested the sensitivity of the disperser mortality probability and weaning mortality probability. These parameters were particularly important to examine as we estimated them from the model itself as described above. Therefore, we systematically varied each parameter and reran our simulations. We then made various measurements of these simulation outputs. Below we illustrate the sensitivity of each parameter. 

#### 4.1 Sensitivity of weaning mortality

```{r,echo=F}
load("~/Desktop/Research/Nagy Lab/Pikas/Modeling/SimpleBodieModel/Model-Outputs/ParameterSensitivity_1000trials_weaning_m.Rdata")
```

```{r,echo=F,fig.cap='Sensitivity of various model measurements to changes in weaning mortality probability'}
par(mfrow=c(2,2),mar=c(1.5,4,1,1),oma=c(3,1,0,0))

plot(weaning_m_vector,trial_trial_mean,pch=16,xlab='',xlim=c(0,1),ylim=c(0,300),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
mtext('Mean population size',side=2,line=3.1,outer=F,cex.lab=1.2)
abline(v=0.52,lty=2,lwd=2)

plot(weaning_m_vector,trial_trial_occupancy,pch=16,xlab='',xlim=c(0,1),ylim=c(0,1),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
mtext('Patch occupancy',side=2,line=3.1,outer=F,cex.lab=1.2)
abline(v=0.52,lty=2,lwd=2)

plot(weaning_m_vector,trial_trial_variance,pch=16,xlab='',xlim=c(0,1),ylim=c(0,1500),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
mtext('Variance in pop size',side=2,line=3.1,outer=F,cex.lab=1.2)
abline(v=0.52,lty=2,lwd=2)

plot(weaning_m_vector,trial_trial_ext_events,pch='*',xlab='',xlim=c(0,1),ylim=c(0,100),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
mtext('# extinction events *', side=2,line=3.3,outer=F,cex.lab=1.2)
abline(v=0.52,lty=2,lwd=2)

points(weaning_m_vector,trial_trial_recol_events,pch='+',xlab='',xlim=c(0,1),ylim=c(0,100),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2,col='red')
mtext('# recolonization events +',side=2,line=2.5,outer=F,cex.lab=1.2,col='red')


#plot(weaning_m_vector,trial_trial_error,pch=16,xlab='',xlim=c(0,1),ylim=c(1970,2000),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
#mtext('Year of south collapse',side=2,line=3.1,outer=F,cex.lab=1.2)
#abline(v=0.52,lty=2,lwd=2)

mtext('Weaning mortality probability',side=1,line=1,outer=T,cex = 1.2)
#mtext('Model setup',side=1,line=0.5,outer=T,at =0.55)
```

  \pagebreak
  
#### 4.2 Sensitivity of dispersal mortality

```{r,echo=F}
load("~/Desktop/Research/Nagy Lab/Pikas/Modeling/SimpleBodieModel/Model-Outputs/ParameterSensitivity_1000trials_d_m.Rdata")
```

```{r,echo=F,fig.cap='Sensitivity of various model measurements to changes in dispersal mortality probability'}
par(mfrow=c(2,2),mar=c(1.5,4,1,1),oma=c(3,1,0,0))

plot(d_m_vector,trial_trial_mean,pch=16,xlab='',xlim=c(0,1),ylim=c(0,200),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
mtext('Mean population size',side=2,line=3.1,outer=F,cex.lab=1.2)
abline(v=0.48,lty=2,lwd=2)

plot(d_m_vector,trial_trial_occupancy,pch=16,xlab='',xlim=c(0,1),ylim=c(0,1),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
mtext('Patch occupancy',side=2,line=3.1,outer=F,cex.lab=1.2)
abline(v=0.48,lty=2,lwd=2)

plot(d_m_vector,trial_trial_variance,pch=16,xlab='',xlim=c(0,1),ylim=c(0,1000),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
mtext('Variance in pop size',side=2,line=3.1,outer=F,cex.lab=1.2)
abline(v=0.48,lty=2,lwd=2)

plot(d_m_vector,trial_trial_ext_events,pch='*',xlab='',xlim=c(0,1),ylim=c(0,100),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
mtext('# extinction events *', side=2,line=3.3,outer=F,cex.lab=1.2)
abline(v=0.48,lty=2,lwd=2)

points(d_m_vector,trial_trial_recol_events,pch='+',xlab='',xlim=c(0,1),ylim=c(0,100),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2,col='red')
mtext('# recolonization events +',side=2,line=2.5,outer=F,cex.lab=1.2,col='red')


#plot(d_m_vector,trial_trial_error,pch=16,xlab='',xlim=c(0,1),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
#mtext('Mean squared error',side=2,line=3.1,outer=F,cex.lab=1.2)
#abline(v=0.48,lty=2,lwd=2)

mtext('Dispersal mortality probability',side=1,line=1,outer=T,cex = 1.2)
#mtext('Model setup',side=1,line=0.5,outer=T,at =0.55)
```

  \pagebreak
  
#### 4.3 Sensitivity of dispersal propensity

```{r,echo=F}
load("~/Desktop/Research/Nagy Lab/Pikas/Modeling/SimpleBodieModel/Model-Outputs/ParameterSensitivity_1000trials_d_prop.Rdata")
```

```{r,echo=F,fig.cap='Sensitivity of various model measurements to changes in dispersal propensity probability'}
par(mfrow=c(2,2),mar=c(1.5,4,1,1),oma=c(3,1,0,0))

plot(d_prop_vector,trial_trial_mean,pch=16,xlab='',xlim=c(0,1),ylim=c(0,120),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
mtext('Mean population size',side=2,line=3.1,outer=F,cex.lab=1.2)
abline(v=0.25,lty=2,lwd=2)

plot(d_prop_vector,trial_trial_occupancy,pch=16,xlab='',xlim=c(0,1),ylim=c(0,1),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
mtext('Patch occupancy',side=2,line=3.1,outer=F,cex.lab=1.2)
abline(v=0.25,lty=2,lwd=2)

plot(d_prop_vector,trial_trial_variance,pch=16,xlab='',xlim=c(0,1),ylim=c(0,1000),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
mtext('Variance in pop size',side=2,line=3.1,outer=F,cex.lab=1.2)
abline(v=0.25,lty=2,lwd=2)

plot(d_prop_vector,trial_trial_ext_events,pch='*',xlab='',xlim=c(0,1),ylim=c(0,100),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
mtext('# extinction events *', side=2,line=3.3,outer=F,cex.lab=1.2)
abline(v=0.25,lty=2,lwd=2)

points(d_prop_vector,trial_trial_recol_events,pch='+',xlab='',xlim=c(0,1),ylim=c(0,100),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2,col='red')
mtext('# recolonization events +',side=2,line=2.5,outer=F,cex.lab=1.2,col='red')


#plot(d_prop_vector,trial_trial_error,pch=16,xlab='',xlim=c(0,1),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
#mtext('Mean squared error',side=2,line=3.6,outer=F,cex.lab=1.2)
#abline(v=0.25,lty=2,lwd=2)

mtext('Dispersal propensity probability',side=1,line=1,outer=T,cex = 1.2)
#mtext('Model setup',side=1,line=0.5,outer=T,at =0.55)
```


  \pagebreak

#### 4.4 Sensitivity of dispersal radius

```{r,echo=F}
load("~/Desktop/Research/Nagy Lab/Pikas/Modeling/SimpleBodieModel/Model-Outputs/ParameterSensitivity_1000trials_radius.Rdata")
```

```{r,echo=F,fig.cap='Sensitivity of various model measurements to changes in maximum dispersal radius'}
par(mfrow=c(2,2),mar=c(1.5,4,1,1),oma=c(3,1,0,0))

plot(radius_vector,trial_trial_mean,pch=16,xlab='',ylim=c(0,120),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2,xlim=c(0,1500))
mtext('Mean population size',side=2,line=3.1,outer=F,cex.lab=1.2)
abline(v=300,lty=2,lwd=2)

plot(radius_vector,trial_trial_occupancy,pch=16,xlab='',xlim=c(0,1500),ylim=c(0,1),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
mtext('Patch occupancy',side=2,line=3.1,outer=F,cex.lab=1.2)
abline(v=300,lty=2,lwd=2)

plot(radius_vector,trial_trial_variance,pch=16,xlab='',xlim=c(0,1500),ylim=c(0,1000),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
mtext('Variance in pop size',side=2,line=3.1,outer=F,cex.lab=1.2)
abline(v=300,lty=2,lwd=2)

plot(radius_vector,trial_trial_ext_events,pch='*',xlab='',xlim=c(0,1500),ylim=c(0,100),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
mtext('# extinction events *', side=2,line=3.3,outer=F,cex.lab=1.2)
abline(v=300,lty=2,lwd=2)

points(radius_vector,trial_trial_recol_events,pch='+',xlab='',xlim=c(0,1500),ylim=c(0,100),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2,col='red')
mtext('# recolonization events +',side=2,line=2.5,outer=F,cex.lab=1.2,col='red')

#plot(radius_vector,trial_trial_error,pch=16,xlab='',xlim=c(0,1500),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
#mtext('Mean squared error',side=2,line=3.6,outer=F,cex.lab=1.2)
#abline(v=300,lty=2,lwd=2)

mtext('Max dispersal distance',side=1,line=1,outer=T,cex = 1.2)
#mtext('Model setup',side=1,line=0.5,outer=T,at =0.55)
```

  \pagebreak

#### 4.5 Sensitivity of over-winter mortality probability

```{r,echo=F}
load("~/Desktop/Research/Nagy Lab/Pikas/Modeling/SimpleBodieModel/Model-Outputs/ParameterSensitivity_1000trials_u.Rdata")
```

```{r,echo=F,fig.cap='Sensitivity of various model measurements to changes in over-winter mortality probability'}
par(mfrow=c(2,2),mar=c(1.5,4,1,1),oma=c(3,1,0,0))

plot(u_vector,trial_trial_mean,pch=16,xlab='',xlim=c(0,1),ylim=c(0,350),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
mtext('Mean population size',side=2,line=3.1,outer=F,cex.lab=1.2)
abline(v=0.37,lty=2,lwd=2)

plot(u_vector,trial_trial_occupancy,pch=16,xlab='',xlim=c(0,1),ylim=c(0,1),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
mtext('Patch occupancy',side=2,line=3.1,outer=F,cex.lab=1.2)
abline(v=0.37,lty=2,lwd=2)

plot(u_vector,trial_trial_variance,pch=16,xlab='',xlim=c(0,1),ylim=c(0,2500),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
mtext('Variance in pop size',side=2,line=3.1,outer=F,cex.lab=1.2)
abline(v=0.37,lty=2,lwd=2)

plot(u_vector,trial_trial_ext_events,pch='*',xlab='',xlim=c(0,1),ylim=c(0,100),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
mtext('# extinction events *', side=2,line=3.3,outer=F,cex.lab=1.2)
abline(v=0.37,lty=2,lwd=2)

points(u_vector,trial_trial_recol_events,pch='+',xlab='',xlim=c(0,1),ylim=c(0,100),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2,col='red')
mtext('# recolonization events +',side=2,line=2.5,outer=F,cex.lab=1.2,col='red')

#plot(u_vector,trial_trial_error,pch=16,xlab='',xlim=c(0,1),las=1,ylab=' ',cex.axis=1.2,cex.lab=1.2)
#mtext('Mean squared error',side=2,line=3.6,outer=F,cex.lab=1.2)
#abline(v=0.37,lty=2,lwd=2)

mtext('Over-winter mortality probability',side=1,line=1,outer=T,cex = 1.2)
#mtext('Model setup',side=1,line=0.5,outer=T,at =0.55)
```




  \pagebreak
  
### 5. The effects of not sampling every patch

As discussed in the main text, not every patch was sampled consistently through the entire census period. Therefore, in all of the analyses and figures, both in the main text and in the supplementary material, we sampled our model's patches similarly to what was done in the field. In other words, we only sampled model patches, if they were also sampled in the field. A total of 13 patches were not sampled consistently. These patches are still important in driving metapopulation dynamics, so they were still included in the model and simply not sampled. Time series plots in the main text and elsewhere show a model census of only sampled patches---to allow for comparison to field data. However, we can compare the effect of not having sampled these patches.

```{r,echo=FALSE}

#could rerun model with just basic actual Bodie setup
load("~/Desktop/Research/Nagy Lab/Pikas/Modeling/SimpleBodieModel/Model-Outputs/Modeloutput_500years_dm048_wm0.52_1000trials_longcensus.Rdata")
par(mfcol=c(3,2), mai = c(0.05, 1, 0,0),oma=c(5,1,5,0.8))
j=1
model_allpatch_census=trial_pop[[j]]
mean_matrix=colSums(model_allpatch_census[1:79,],na.rm=T)
plot(1972:2471,colSums(model_allpatch_census[1:79,],na.rm=T),type='l',col='grey',ylim=c(0,250),ylab='Total',xaxt='n',las=1,xlim=c(1970,2010))
for (j in 2:50){
model_allpatch_census=trial_pop[[j]]
points(1972:2471,colSums(model_allpatch_census[1:79,],na.rm=T),type='l',col='grey',ylim=c(0,100))
mean_matrix=rbind(mean_matrix,colSums(model_allpatch_census[1:79,],na.rm=T))
}

#points(1972:2471,colMeans(mean_matrix),lwd=3,col='black',type='l')

######################################################
j=1
model_allpatch_census=trial_pop[[j]]
mean_matrix=colSums(model_allpatch_census[c(38:56,59:79),],na.rm=T)
plot(1972:2471,colSums(model_allpatch_census[c(38:56,59:79),],na.rm=T),type='l',col='grey',ylim=c(0,250),ylab='North',xaxt='n',las=1,xlim=c(1970,2010))
for (j in 2:50){
model_allpatch_census=trial_pop[[j]]
points(1972:2471,colSums(model_allpatch_census[c(38:56,59:79),],na.rm=T),type='l',col='grey',ylim=c(0,100))
mean_matrix=rbind(mean_matrix,colSums(model_allpatch_census[c(38:56,59:79),],na.rm=T))
}

#points(1972:2471,colMeans(mean_matrix),lwd=3,col='black',type='l')

######################################################
j=1
model_allpatch_census=trial_pop[[j]]
mean_matrix=colSums(model_allpatch_census[c(1:37,57,58),],na.rm=T)
plot(1972:2471,colSums(model_allpatch_census[c(1:37,57,58),],na.rm=T),type='l',col='grey',ylim=c(0,100),ylab='South',las=1,xlim=c(1970,2010))
for (j in 2:30){
model_allpatch_census=trial_pop[[j]]
points(1972:2471,colSums(model_allpatch_census[c(1:37,57,58),],na.rm=T),type='l',col='grey',ylim=c(0,100))
mean_matrix=rbind(mean_matrix,colSums(model_allpatch_census[c(1:37,57,58),],na.rm=T)) 
}

#points(1972:2471,colMeans(mean_matrix),lwd=3,col='black',type='l')

################################################################
################################################################
################################################################
################################################################
par(mai = c(0.05, 0.5, 0,0.5))   
j=1
model_census=trial_sampled_pop[[j]]
mean_matrix=colSums(model_census[1:79,],na.rm=T)
plot(1972:2471,colSums(model_census[1:79,],na.rm=T),type='l',ylim=c(0,250),ylab=' ',las=1,col=rgb(0.5,0.5,0.5,0.5),xaxt='n',xlim=c(1970,2010))
for (j in 2:50){
model_census=trial_sampled_pop[[j]]
points(1972:2471,colSums(model_census[1:79,],na.rm=T),type='l',ylim=c(0,100),col=rgb(0.5,0.5,0.5,0.5))
mean_matrix=rbind(mean_matrix,colSums(model_census[1:79,],na.rm=T))

}

points(as.numeric(names(sampled_census_bodie)),colSums(sampled_census_bodie[1:79,1:20],na.rm=T),pch=16,col='black')

######################################################################
######################################################################

j=1
model_census=trial_sampled_pop[[j]]
mean_matrix=colSums(model_census[c(38:56,59:79),],na.rm=T)
plot(1972:2471,colSums(model_census[c(38:56,59:79),],na.rm=T),type='l',ylim=c(0,250),ylab=' ',xaxt='n',col=rgb(0.5,0.5,0.5,0.5),las=1,xlim=c(1970,2010))
for (j in 2:50){
model_census=trial_sampled_pop[[j]]
points(1972:2471,colSums(model_census[c(38:56,59:79),],na.rm=T),type='l',col=rgb(0.5,0.5,0.5,0.5),ylim=c(0,100))
mean_matrix=rbind(mean_matrix,colSums(model_census[c(38:56,59:79),],na.rm=T))
}


points(as.numeric(names(sampled_census_bodie)),colSums(sampled_census_bodie[c(38:56,59:79),1:20],na.rm=T),pch=16,col='black')

######################################################################

j=1
model_census=trial_sampled_pop[[j]]
mean_matrix=colSums(model_census[c(1:37,57,58),],na.rm=T)
plot(1972:2471,colSums(model_census[c(1:37,57,58),],na.rm=T),type='l',col=rgb(0.5,0.5,0.5,0.5),ylim=c(0,100),ylab='  ',xlim=c(1970,2010),las=1)
for (j in 2:50){
model_census=trial_sampled_pop[[j]]
points(1972:2471,colSums(model_census[c(1:37,57,58),],na.rm=T),type='l',col=rgb(0.5,0.5,0.5,0.5),ylim=c(0,100))
mean_matrix=rbind(mean_matrix,colSums(model_census[c(1:37,57,58),],na.rm=T))
}


points(as.numeric(names(sampled_census_bodie)),colSums(sampled_census_bodie[c(1:37,57,58),1:20],na.rm=T),pch=16,col='black')
#abline(h=14,lwd=2,lty=2)

mtext('Population size (# of individuals)',side = 2,outer = TRUE,line=-1)
  mtext('Time (years)',side = 1,outer = TRUE,line=2.6,at=0.49)
  mtext('All patches',side = 3,outer = TRUE,line=1,at=0.31)
  mtext('Only sampled patches',side = 3,outer = TRUE,line=1,at=0.75)
  
  ```
  
### 6. Long-term trends for sampled and unsampled patches
  
  Several patches were not sampled consistently for the entire census period. Therefore we sampled our model in the same way as the field. This allowed for comparison between model output and field data. However, we can also examine what is happening to the metapopulation when we also examine patches that were "unsampled".
  
  ```{r,echo=FALSE}
load("~/Desktop/Research/Nagy Lab/Pikas/Modeling/SimpleBodieModel/Model-Outputs/Modeloutput_500years_dm048_wm0.52_1000trials_longcensus.Rdata")
    par(mfcol=c(3,2), mai = c(0.05, 1, 0,0),oma=c(5,1,5,0.8))

  
  j=1
  model_allpatch_census=trial_pop[[j]]
  mean_matrix=colSums(model_allpatch_census[1:79,],na.rm=T)
  plot(1972:2471,colSums(model_allpatch_census[1:79,],na.rm=T),type='l',col='grey',ylim=c(0,250),ylab='Total',xaxt='n',las=1,xlim=c(1970,2270))
  for (j in 2:30){
    model_allpatch_census=trial_pop[[j]]
    points(1972:2471,colSums(model_allpatch_census[1:79,],na.rm=T),type='l',col='grey',ylim=c(0,100))
    mean_matrix=rbind(mean_matrix,colSums(model_allpatch_census[1:79,],na.rm=T))
  }
  
  #points(1972:2471,colMeans(mean_matrix),lwd=3,col='black',type='l')
  
  ######################################################
  j=1
  model_allpatch_census=trial_pop[[j]]
  mean_matrix=colSums(model_allpatch_census[c(38:56,59:79),],na.rm=T)
  plot(1972:2471,colSums(model_allpatch_census[c(38:56,59:79),],na.rm=T),type='l',col='grey',ylim=c(0,250),ylab='North',xaxt='n',las=1,xlim=c(1970,2270))
  for (j in 2:30){
    model_allpatch_census=trial_pop[[j]]
    points(1972:2471,colSums(model_allpatch_census[c(38:56,59:79),],na.rm=T),type='l',col='grey',ylim=c(0,100))
    mean_matrix=rbind(mean_matrix,colSums(model_allpatch_census[c(38:56,59:79),],na.rm=T))
  }
  
  #points(1972:2471,colMeans(mean_matrix),lwd=3,col='black',type='l')
  
  ######################################################
  j=1
  model_allpatch_census=trial_pop[[j]]
  mean_matrix=colSums(model_allpatch_census[c(1:37,57,58),],na.rm=T)
  plot(1972:2471,colSums(model_allpatch_census[c(1:37,57,58),],na.rm=T),type='l',col='grey',ylim=c(0,100),ylab='South',las=1,xlim=c(1970,2270))
  for (j in 2:30){
    model_allpatch_census=trial_pop[[j]]
    points(1972:2471,colSums(model_allpatch_census[c(1:37,57,58),],na.rm=T),type='l',col='grey',ylim=c(0,100))
    mean_matrix=rbind(mean_matrix,colSums(model_allpatch_census[c(1:37,57,58),],na.rm=T)) 
  }
  
  #points(1972:2971,colMeans(mean_matrix),lwd=3,col='black',type='l')
  
  ################################################################
  ################################################################
  ################################################################
  ################################################################
  par(mai = c(0.05, 0.5, 0,0.5))   
  j=1
  model_census=trial_sampled_pop[[j]]
  mean_matrix=colSums(model_census[1:79,],na.rm=T)
  plot(1972:2471,colSums(model_census[1:79,],na.rm=T),type='l',ylim=c(0,250),ylab=' ',las=1,col=rgb(0.5,0.5,0.5,0.5),xaxt='n',xlim=c(1970,2270))
  for (j in 2:30){
    model_census=trial_sampled_pop[[j]]
    points(1972:2471,colSums(model_census[1:79,],na.rm=T),type='l',ylim=c(0,100),col=rgb(0.5,0.5,0.5,0.5))
    mean_matrix=rbind(mean_matrix,colSums(model_census[1:79,],na.rm=T))
    
  }
  
  points(as.numeric(names(sampled_census_bodie)),colSums(sampled_census_bodie[1:79,1:20],na.rm=T),pch=16,col='black')
  
  ######################################################################
  ######################################################################
  
  j=1
  model_census=trial_sampled_pop[[j]]
  mean_matrix=colSums(model_census[c(38:56,59:79),],na.rm=T)
  plot(1972:2471,colSums(model_census[c(38:56,59:79),],na.rm=T),type='l',ylim=c(0,250),ylab=' ',xaxt='n',col=rgb(0.5,0.5,0.5,0.5),las=1,xlim=c(1970,2270))
  for (j in 2:50){
    model_census=trial_sampled_pop[[j]]
    points(1972:2471,colSums(model_census[c(38:56,59:79),],na.rm=T),type='l',col=rgb(0.5,0.5,0.5,0.5),ylim=c(0,100))
    mean_matrix=rbind(mean_matrix,colSums(model_census[c(38:56,59:79),],na.rm=T))
  }
  
  
  points(as.numeric(names(sampled_census_bodie)),colSums(sampled_census_bodie[c(38:56,59:79),1:20],na.rm=T),pch=16,col='black')
  
  ######################################################################
  
  j=1
  model_census=trial_sampled_pop[[j]]
  mean_matrix=colSums(model_census[c(1:37,57,58),],na.rm=T)
  plot(1972:2471,colSums(model_census[c(1:37,57,58),],na.rm=T),type='l',col=rgb(0.5,0.5,0.5,0.5),ylim=c(0,100),ylab='  ',xlim=c(1970,2270),las=1)
  for (j in 2:50){
    model_census=trial_sampled_pop[[j]]
    points(1972:2471,colSums(model_census[c(1:37,57,58),],na.rm=T),type='l',col=rgb(0.5,0.5,0.5,0.5),ylim=c(0,100))
    mean_matrix=rbind(mean_matrix,colSums(model_census[c(1:37,57,58),],na.rm=T))
  }
  
  
  points(as.numeric(names(sampled_census_bodie)),colSums(sampled_census_bodie[c(1:37,57,58),1:20],na.rm=T),pch=16,col='black')
  #abline(h=14,lwd=2,lty=2)
  
  mtext('Population size (# of individuals)',side = 2,outer = TRUE,line=-1)
  mtext('Time (years)',side = 1,outer = TRUE,line=2.6,at=0.49)
  mtext('All patches',side = 3,outer = TRUE,line=1,at=0.31)
  mtext('Only sampled patches',side = 3,outer = TRUE,line=1,at=0.75)
  
  ```
  
#### 6.1 Probability of extinction in the future
  
  ```{r,tidy=T,fig.cap="Probability of extinction of whole population...",echo=FALSE}
  #this chuck calculates the proportion of patches that went extinct by a future time  
load("~/Desktop/Research/Nagy Lab/Pikas/Modeling/SimpleBodieModel/Model-Outputs/Modeloutput_500years_dm048_wm0.52_1000trials_longcensus.Rdata")
   par(mfrow=c(1,1),mar=c(3,3,1,1),oma=c(2,2,0,0))
  end_times = seq(10,500,by=10)
  Prop_Ext=matrix(0,nrow=1,ncol=length(end_times))
  for (k in 1:length(end_times)){
    end_pop_size=rep(0,times=1000)
    
    for (j in 1:1000){
      model_allpatch_census=trial_pop[[j]]
      end_pop_size[j] = colSums(model_allpatch_census)[end_times[k]]
    }
    end_pop_size[end_pop_size>0]=1
    Prop_Ext[k]=1- (sum(end_pop_size)/1000)
    
  }
  
  plot(end_times,Prop_Ext,ylab=" ",xlab=" ",las=1,pch=16,ylim=c(0,0.4),cex.axis=1.2)
      mtext('Probability of extinction',side=2,line=3,cex=1.2)
    mtext('Time (years)',side=1,line=3,cex=1.2)
    
  ```
  
  
  \pagebreak
  
### 7. Individual patch dynamics
  
  In addition to examining overall metapopulation trends over time, it is also useful to examine the dynamics of each patch over time. This is best illustrated on the landscape of patches. 
  
  ```{r, fig.width=4,fig.height=8,echo=FALSE,fig.cap='Territory size is represented by the size of the circles for each patch'}
  #should maintain proper figure margins
  territories=c(6,5,3,7,3,4,3,4,5,5,5,3,3,4,3,3,4,4,3,3,
                5,5,3,3,3,4,4,3,3,2,3,4,3,3,4,3,5,5,9,3,5,
                5,4,14,4,5,5,7,13,4,3,3,3,4,2,5,11,12,3,13,
                14,13,7,15,50,3,12,7,4,4,3,5,16,10,3,4,11,12,3)
  
  par(mfcol=c(1,1), mai = c(0.7, 0.7, 0.7,0.7),oma=c(0,0,0,0))
  disp1<-read.table('coordinates.1.txt',header=TRUE)
  col_seq=rep(gray.colors(2,start=0.1,end=0.5,alpha=0.2)[1],times=79)
  col_seq[c(1:19,21:23,57,58)]=gray.colors(2,start=0.1,end=0.5,alpha=0.2)[2]
  symbols(disp1$xcoor1,disp1$ycoor1,circles=territories,inches=1/5, ann=F, bg=col_seq, fg='black',ylim=c(0,4000),xlim=c(0,2000),main=)
  text(disp1$xcoor1,disp1$ycoor1, labels = 1:79, cex=0.38,pos=4) 
  abline(h=2330,lty=2)
  ```    
  
  
  ```{r, fig.width=10,fig.height=16,echo=FALSE, fig.cap='Size of patches over time for census data. The size of the circles represent the number of individuals per patch.'}
  
  par(mfrow=c(4,5), mai = c(0, 0, 0,0),oma=c(1,1,1,1))
  disp1<-read.table('coordinates.1.txt',header=TRUE)
  col_seq=rep(gray.colors(2,start=0.1,end=0.5,alpha=0.2)[1],times=79)
  col_seq[c(1:19,21:23,57,58)]=gray.colors(2,start=0.1,end=0.5,alpha=0.2)[2]
  
  for (q in 1:20){
    symbols(disp1$xcoor1,disp1$ycoor1,circles=sampled_census_bodie[,q],inches=1/5, bg=col_seq, fg='black',ylim=c(0,4000),xlim=c(0,2000),main=" ",ylab=" ",xlab=" ",xaxt='n',yaxt='n')
    mtext(text=(names(sampled_census_bodie)[q]), side=1,line=-2,outer=F)
    abline(h=2330,lty=2)
    #text(disp1$xcoor1,disp1$ycoor1, labels = 1:79, cex=0.38,pos=4) 
    
  }
  
  ```    
  
  \pagebreak
  
  ### References
  
  
  
  
  
  
  